<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.acmed.his.dao.ZhangYaoMapper">
    <select id="getUnDismantleList" resultType="com.acmed.his.model.PrescriptionItem">
        select item.*
        from t_b_prescription_item item
        LEFT JOIN t_b_apply apply on item.applyid = apply.id
        where item.zyorderstatus = 0 AND item.paystatus =1 and apply.orgcode = #{orgCode} AND apply.status = 1
    </select>

    <select id="getUnSubmitOrder" resultType="com.acmed.his.model.ZyOrder">
        select * from t_zy_order where paystatus = 0 and orgcode = #{orgCode}
        and zystoreid in
        <foreach collection="storeIdList" separator="," open="(" close=")" item="zyStoreId">
            #{zyStoreId}
        </foreach>
    </select>

    <select id="getUnSubmitOrderItem" resultType="com.acmed.his.model.dto.ZyOrderItemUnsubmitDto">
        select t1.id as itemId, t1.orderid, t1.applyid,
        t1.drugname, t1.num, t1.retailprice, t1.fee, t1.manufacturername,
        t2.orderno, t2.drugfee ,t2.zyStoreId as storeId,
        t3.prescriptionno as prescriptionNo
        from t_zy_order_item t1
        LEFT JOIN t_zy_order t2 on t1.orderid = t2.id
        LEFT JOIN t_b_prescription t3 on t1.applyid = t3.applyid
        where t1.removed = '0' and t1.removed = '0'
        and t2.paystatus = 0
        <if test="@Ognl@isNotEmpty(name) ">
            and t2.id in (select id from t_zy_order where orderno like concat('%', #{name} , '%')
                          UNION ALL
                          select td.id from t_zy_order_item tm LEFT JOIN t_zy_order td = tm.orderid = td.id
                            where tm.drugName like concat('%', #{name} , '%') and td.paystatus = 0)
        </if>
        ORDER BY t2.orderno desc
    </select>

    <update id="updateItemDismantleStatus">
        update t_b_prescription_item set zyOrderStatus =1 where id in
        <foreach collection="ids" separator="," open="(" close=")" item="id">
            #{id}
        </foreach>
    </update>




    <select id="statisDrugUsed" resultType="java.util.Map">
        select zydrugid,count(1) as num from t_b_prescription_item t1
        LEFT JOIN t_b_prescription t2 on t1.prescriptionid = t2.id
        where zydrugid in
        <foreach collection="drugIdList" item="drugId" open="(" close=")" separator=",">
            #{drugId}
        </foreach>
        and t2.orgcode = #{orgCode} and t1.paystatus = 1
        group by zydrugid
    </select>
</mapper>